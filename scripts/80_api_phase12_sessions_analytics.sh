#!/usr/bin/env bash
set -euo pipefail

API="/opt/pwl-os/api/server.js"

# 1) Add DB tables inside initDb() by inserting before the closing backtick of the big CREATE block.
# We'll append extra CREATE TABLE statements after logs table.
perl -0777 -i -pe 's/create table if not exists logs \([\s\S]*?\);\n  `\);/create table if not exists logs (\n      id serial primary key,\n      venue_id int references venues(id),\n      type text not null,\n      payload jsonb not null,\n      created_at timestamptz not null default now()\n    );\n\n    create table if not exists venue_sessions (\n      id serial primary key,\n      venue_id int not null references venues(id),\n      user_id int not null references users(id),\n      uid_tag text,\n      started_at timestamptz not null default now(),\n      ended_at timestamptz\n    );\n\n    create table if not exists analytics_events (\n      id serial primary key,\n      name text not null,\n      venue_id int references venues(id),\n      user_id int references users(id),\n      payload jsonb not null default '{}'::jsonb,\n      created_at timestamptz not null default now()\n    );\n  `);/s' "$API"

# 2) Add public venues endpoint + guest checkin/checkout + me + track + admin analytics summary
# Insert before await initDb()
perl -0777 -i -pe 's/await initDb\(\);\n/app.get("\\/public\\/venues", async () => {\n  const r = await pool.query("select id,name,city from venues order by id desc");\n  return r.rows;\n});\n\napp.get("\\/me", { preHandler: requireAuth }, async (req) => {\n  const u = await pool.query("select id,email,role,venue_id,points from users where id=$1", [req.user.uid]);\n  const user = u.rows[0];\n  const s = await pool.query(\n    "select * from venue_sessions where user_id=$1 and ended_at is null order by id desc limit 1",\n    [req.user.uid]\n  );\n  return { user, session: s.rows[0] || null };\n});\n\napp.post("\\/guest\\/checkin", async (req, reply) => {\n  const { venue_id, uid_tag } = req.body || {};\n  if (!venue_id) return reply.code(400).send({ error: "venue_id required" });\n\n  // Create a guest user record (Phase 1.2)\n  const u = await pool.query(\n    "insert into users (role, venue_id, points) values (\\x27GUEST\\x27,$1,0) returning *",\n    [venue_id]\n  );\n  const user = u.rows[0];\n\n  // Start session\n  const s = await pool.query(\n    "insert into venue_sessions (venue_id,user_id,uid_tag) values ($1,$2,$3) returning *",\n    [venue_id, user.id, uid_tag || null]\n  );\n\n  // Reward points for check-in\n  await pool.query("update users set points=points+10 where id=$1", [user.id]);\n\n  await pool.query("insert into logs (venue_id,type,payload) values ($1,\\x27CHECKIN\\x27,$2)",\n    [venue_id, { user_id: user.id, uid_tag: uid_tag || null, points_awarded: 10 }]\n  );\n\n  await pool.query("insert into analytics_events (name, venue_id, user_id, payload) values (\\x27checkin\\x27,$1,$2,$3)",\n    [venue_id, user.id, { uid_tag: uid_tag || null }]\n  );\n\n  return { token: signToken(user), venue_id, user_id: user.id, session_id: s.rows[0].id, points_awarded: 10 };\n});\n\napp.post("\\/guest\\/checkout", { preHandler: requireAuth }, async (req, reply) => {\n  const u = await pool.query("select id,venue_id from users where id=$1", [req.user.uid]);\n  if (u.rowCount === 0) return reply.code(404).send({ error: "user not found" });\n\n  const user = u.rows[0];\n  const s = await pool.query(\n    "update venue_sessions set ended_at=now() where user_id=$1 and ended_at is null returning *",\n    [user.id]\n  );\n\n  await pool.query("insert into logs (venue_id,type,payload) values ($1,\\x27CHECKOUT\\x27,$2)",\n    [user.venue_id, { user_id: user.id }]\n  );\n\n  await pool.query("insert into analytics_events (name, venue_id, user_id, payload) values (\\x27checkout\\x27,$1,$2,$3)",\n    [user.venue_id, user.id, {}]\n  );\n\n  return { ok: true, ended: s.rows[0] || null };\n});\n\napp.post("\\/track", async (req, reply) => {\n  const { name, venue_id, payload } = req.body || {};\n  if (!name) return reply.code(400).send({ error: "name required" });\n\n  // Try to attach user_id if bearer token provided, but dont require it\n  let userId = null;\n  const h = req.headers.authorization || \"\";\n  const token = h.startsWith(\"Bearer \") ? h.slice(7) : null;\n  if (token) {\n    try { userId = jwt.verify(token, JWT_SECRET).uid; } catch {}\n  }\n\n  const r = await pool.query(\n    "insert into analytics_events (name, venue_id, user_id, payload) values ($1,$2,$3,$4) returning *",\n    [name, venue_id || null, userId, payload || {}]\n  );\n  return { ok: true, id: r.rows[0].id };\n});\n\napp.get("\\/admin\\/analytics/summary", { preHandler: requireRole([\"MAIN_ADMIN\"]) }, async () => {\n  const r1 = await pool.query(\n    \"select count(*)::int as checkins_24h from analytics_events where name=\\x27checkin\\x27 and created_at > now() - interval \\x271 day\\x27\"\n  );\n  const r2 = await pool.query(\n    \"select count(*)::int as pageviews_24h from analytics_events where name=\\x27pageview\\x27 and created_at > now() - interval \\x271 day\\x27\"\n  );\n  const r3 = await pool.query(\n    \"select count(*)::int as active_sessions from venue_sessions where ended_at is null\"\n  );\n  return { ...r1.rows[0], ...r2.rows[0], ...r3.rows[0] };\n});\n\nawait initDb();\n/s' "$API"

echo "âœ… API Phase 1.2: sessions + analytics + public venues + guest checkin + /me + tracking + admin summary"
